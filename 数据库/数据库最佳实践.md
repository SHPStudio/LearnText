# 并发优化
## 介绍
  比如秒杀的时候，多线程同时操作数据库中的一条数据。也就是很多人秒杀同一个商品时，需要同时对这个商品的库存进行操作。
  如果并发量过大而且还不进行处理。那么就会造成tps过低。
## 优化方案
1. 首先把并发的线程数在server服务器端进行串行处理，也就是排一下队。
2. 对排队进行优化，最后提交的时候把所有线程所要处理的数据汇总成一个最后对数据库的请求。

# 数据库事务
## 数据库事务不要与RPC远程调用放到一起
  数据库事务中不允许存在RPC远程调用，如果远程调用过程中出现超时，将会一直锁定数据库，导致tps降低。特别是使用Spring声明式事务的`
@Transactional`注解，虽然比较方便，但很容易造成该问题。

  可以考虑使用编程式事务，虽然麻烦一点，但能灵活控制事务范围。
```
// 引入事务管理器
@Autowired
TransactionTemplate transactionTemplate;

@Autowired
PlatformTransactionManager transactionManager;

```

```
//开启事务保存数据
boolean result = transactionTemplate.execute(new TransactionCallback<Boolean>() {
    @Override
    public Boolean doInTransaction(TransactionStatus status) {
        try {
            // TODO something
        } catch (Exception e) {
            //TransactionAspectSupport.currentTransactionStatus().setRollbackOnly(); //手动开启事务回滚
            status.setRollbackOnly();
            logger.error(e.getMessage(), e);
            return false;
        }
        return true;
    }
});
```
